!function(){"use strict";var t,e,n,a,i,r={},s=[],o={},u=[],c="normalized",l="",d=["rgb(166,206,227)","rgb(31,120,180)","rgb(178,223,138)","rgb(51,160,44)","rgb(251,154,153)","rgb(227,26,28)","rgb(253,191,111)","rgb(255,127,0)","rgb(202,178,214)","rgb(106,61,154)"],p={give:"Hosted",get:"Attended",mutual:"Shared"},g=function(t){if(t){if("Expert"===t||"Neutral - CEP"===t||"Neutral - WestEd"===t)return;t.length>l.length&&(l=t),o[t]||(o[t]=1)}},v=function(t){var e=[];t.get&&e.push(t.get);for(var n=2;t["get_"+n];)e.push(t["get_"+n]),n++;return e},h=function(){$.each(u,function(t,e){g(e.give),$.map(v(e),g)});var e=t.append("text").attr("id","maxLabel").text(l);i=$("#maxLabel")[0].getBBox().width,e.remove();var n=0;$.each(Object.keys(o).sort(),function(t,e){s=s.concat(n,n+1,n+2),o[e]={name:e,relationships:{give:{},get:{},mutual:{}},counts:{}},$.each(["give","get","mutual"],function(t,a){o[e][a]=n,o[e].counts[a]={count:0,participants:0,districts:{}},s[n]=[];for(var i=0;i<Object.keys(o).length;i++)s[n].push(0),s[n].push(0),s[n].push(0);r[n]={index:n,name:e,type:a},n++})});var a=function(t,e,n,a,i){if(t!==e){var u=function(t,e,i){var s={id:n,type:i,count:a},u=o[r[t].name],c=o[r[e].name];void 0===u.relationships[i][c.name]?(u.relationships[i][c.name]=[s],u.counts[i].districts[c.name]={count:0,participants:0}):u.relationships[i][c.name].push(s)};i?(s[e][t]+=1/a,u(t,e,"mutual")):(s[e][t]++,s[t][e]+="normalized"===c?1/a:1,u(t,e,"give"),u(e,t,"get"))}};$.each(u,function(t,e){var n=v(e);if(e.give&&"Cal. Ed. Partners"!==o[e.give]){var i=o[e.give].give;o[e.give].counts.give.count++,o[e.give].counts.give.participants+=n.length,$.each(n,function(r,s){var u=o[s].get;o[s].counts.get.count++,o[s].counts.get.participants+=n.length,a(i,u,t,n.length),o[e.give].counts.give.districts[s].count++,o[e.give].counts.give.districts[s].participants+=n.length})}else $.each(n,function(e,i){o[i].counts.mutual.count++,o[i].counts.mutual.participants+=n.length,$.each(n,function(e,r){var s=o[i].mutual,u=o[r].mutual;a(s,u,t,n.length,!0),s!==u&&(o[i].counts.mutual.districts[r].count++,o[i].counts.mutual.districts[r].participants+=n.length)})})}),_()},f=function(t){return a.groups()[t].startAngle},m=function(t){return a.groups()[t].endAngle},y=function(){c=$("input:radio[name=display-type]:checked").val(),s=[],l="",o={},r={},t.selectAll("*").remove(),h(),$("#info").hide()},x=function(){n.style("top",d3.event.pageY+5+"px"),n.style("left",d3.event.pageX+5+"px")},b=function(t){x(),n.style("display","block"),n.html(t)},A=function(){n.style("display","none")},k=function(t,e,n,a){$("#info .panel-title").html(t),$("#info .list-group").html(""),$.each(e,function(t,e){w(e.id,e.type)}),$("#info").css("display","flex"),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$('#info .nav-tabs li a[href="#'+n+'s"]').tab("show"),$("#info .nav-tabs>li").toggle(!a)},w=function(t,e){var n=u[t],a=n.when+" - "+n.specificwhat;"Expert"===n.give&&(a+=" (Expert)"),"Cal. Ed. Partners"===o[n.give]&&(a+=" (Mutual)");var i="";i+=n._origGive?"<div>Host: "+n._origGive+"</div>":"",i+="Participants: "+v(n).join(", ");var r=n.survey&&n.survey.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.survey+'"> Survey</a>':"",s=n.onlinespace&&n.onlinespace.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.onlinespace+'"> Online Space</a>':"",c=r+s;$("#info #"+e+"s .list-group").append('<li class="row-info list-group-item"><span class="pull-right btn-group">'+c+'</span><h4 class="list-group-item-heading">'+a+'</h4><div class="list-group-item-text">'+i+"</div></li>")},_=function(){var e=function(t){return o[r[t.index].name]},n=function(e,n){return function(a,i){t.selectAll(".chords path").filter(function(t){return n?r[t.source.index].name!==r[a.index].name&&r[t.target.index].name!==r[a.index].name:a.source?t.source.index!==a.source.index||t.target.index!==a.target.index:t.source.index!==i&&t.target.index!==i}).transition().style("opacity",e)}},i=function(t){var e=r[t.index],n=d[Object.keys(o).indexOf(e.name)];return n};a=d3.layout.chord().padding(.02).sortChords(d3.descending).sortSubgroups(d3.descending).matrix(s),t.append("g").attr("class","district-groups").selectAll("path").data(a.groups().filter(function(t){return"give"===r[t.index].type})).enter().append("path").attr("class","district-group").style("fill",function(t){return i(t)}).style("stroke",function(t){return i(t)}),t.append("g").attr("class","chord-groups").selectAll("path").data(a.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return i(t)}).style("stroke",function(t){return i(t)}).on("mouseover",function(t,a){var i=e(t),s=r[t.index].type,o=p[s],u=i.counts[s].count,c=i.name+" "+o+" "+u+("mutual"===s?" Mutual":"")+" Experience"+(1===u?"":"s");b(c),n(.1)(t,a)}).on("mouseout",n(1)),t.append("g").attr("class","chords").selectAll("path").data(a.chords).enter().append("path").attr("class","chord").style("fill",function(t){var e=r[t.source.index];return"get"===e.type?i(t.target):"mutual"===e.type?"#999":i(t.source)}).style("opacity",1).on("click",function(t){var n="give"===r[t.source.index].type?"source":"target",a="give"===r[t.source.index].type?"target":"source",i=t[n].index,s=e(t[n]),o=e(t[a]),u=r[i].type,c="";c="mutual"===u?"Mutual between "+s.name+" and "+o.name:s.name+" to "+o.name,k(c,s.relationships[u][o.name],u,!0)}).on("mouseover",function(t,a){var i="give"===r[t.source.index].type?"source":"target",s="give"===r[t.source.index].type?"target":"source",o=t[i].index,u=e(t[i]),c=e(t[s]),l="",d=u.counts[r[o].type].districts[c.name];l="mutual"===r[o].type?u.name+" and "+c.name:u.name+" to  "+c.name,l+="<br>"+d.count+("mutual"===r[o].type?" Mutual":"")+" Experience"+(1===d.count?"":"s"),b(l),n(.1)(t,a)}).on("mouseout",n(1)),t.append("g").attr("class","sublabels").selectAll("text").data(a.groups).enter().append("text").attr("class","glyphicon sublabel").attr("pointer-events","none").each(function(t){t.angle=(f(t.index)+m(t.index))/2}).attr("dy",".4em").attr("fill",function(t){return d3.rgb(i(t)).darker(3)}),t.append("g").attr("class","labels").selectAll("text").data(a.groups().filter(function(t){return"give"===r[t.index].type})).enter().append("text").attr("class","district-label").each(function(t){t.center=(t.startAngle+m(t.index+2))/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.center>Math.PI?"end":null}).text(function(t){return r[t.index].name}),d3.selectAll(".district-label, .district-group").on("mouseover",function(t,a){var i=e(t),r=i.name+" - "+(i.counts.give.count+i.counts.get.count+i.counts.mutual.count)+" Experiences";b(r),n(.1,!0)(t,a)}).on("mouseout",n(1,!0)),d3.selectAll(".sublabel, .chord-group, .district-group, .district-label").on("click",function(t){var n=e(t),a={};$.each(n.relationships,function(t,e){$.each(e,function(e,n){$.each(n,function(e,n){a[n.id]={id:n.id,type:t}})})}),k(n.name,a,r[t.index].type)}),M()},M=function(){var e=$("#viz-container").width(),n=$("#content").height(),a=Math.min(e,n);$("#viz-container svg").attr("width",a).attr("height",a),t.attr("transform","translate("+a/2+","+a/2+")");var s=.5*a-i-10,o=.99*s,u=.98*o,c=.94*u,l=P(.7*(u-c));t.selectAll(".chord-group").attr("d",d3.svg.arc().innerRadius(c).outerRadius(u)),t.selectAll(".district-group").attr("d",function(t){return d3.svg.arc().startAngle(f(t.index)).endAngle(m(t.index+2)).innerRadius(o).outerRadius(s)()}),t.selectAll(".chord").attr("d",d3.svg.chord().radius(c)),t.selectAll(".sublabel").attr("font-size",l+"px").attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(c+P(.15*(u-c)))+")"}).text(function(t){return(t.endAngle-t.startAngle)*c>l?"give"===r[t.index].type?"":"get"===r[t.index].type?"":"":void 0}),t.selectAll(".district-label").attr("transform",function(t){return"rotate("+(180*t.center/Math.PI-90)+")translate("+(s+5)+")"+(t.center>Math.PI?"rotate(180)":"")})},E=function(){$(".loading").hide(),$("#controls").css("display","flex"),t=d3.select("#viz-container").append("svg").attr("id","chordGraph").append("g").on("mousemove",function(){"none"!==n.style("display")&&x()}).on("mouseout",A),e=d3.select("#info"),$("#controls input").on("change",y),$(window).on("resize",M),n=d3.select("#content").append("div").attr("id","tooltip")},P=function(t){return+(Math.round(t+"e+2")+"e-2")};$(function(){var t,e=function(){t=Tabletop.init({key:"187AL-Ve6sOLP_-j58xk8ANHi1cZfheDzDSMInC4snOg",callback:function(t){if(!u[0]){var e=Object.keys(t);$.each(e,function(t,e){$(".worksheets").append("<option>"+e+"</option>")});{$(".worksheets").find(":selected").text()}E();var n={},a={};$.each(t["CALLI - 4-6 Language Development"].elements,function(t,e){a[e.surveyname]?"Attended"===e.hostattendmutual?n[e.surveyname][e.account]=!0:"Hosted"===e.hostattendmutual&&(a[e.surveyname].give=e.account,a[e.surveyname]._origGive=e.account):(a[e.surveyname]={},n[e.surveyname]={},a[e.surveyname].specificwhat=e.surveyname,a[e.surveyname].when=e.date,"Hosted"===e.hostattendmutual?(a[e.surveyname].give=e.account,a[e.surveyname]._origGive=e.account):"Attended"===e.hostattendmutual?n[e.surveyname][e.account]=!0:"Mutual"===e.hostattendmutual&&(a[e.surveyname].give="Cal. Ed. Partners"),a[e.surveyname].essentialQuestions=e.essentialquestions)}),$.each(n,function(t,e){var n="get",i=0;$.each(e,function(e){i>0&&(n="get_"+i),a[t][n]=e,i++})});var i=1;$.each(a,function(t,e){e.rowNumbers=i,u.push(e),i++}),$.each(u,function(t,e){e.give=$.trim(e.give),e.get=$.trim(e.get);for(var n=1;e["get_"+n];)e["get_"+n]=$.trim(e["get_"+n]),n++}),h()}},debug:!0})},n=function(){u[0]||e()};n()})}();