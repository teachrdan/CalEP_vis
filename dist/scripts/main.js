!function(){"use strict";var t,e,n,a,i,o=[],r=[],s={},c="normalized",u={},l={},d=[],p="",g=[],h={},m=["rgb(166,206,227)","rgb(31,120,180)","rgb(178,223,138)","rgb(51,160,44)","rgb(251,154,153)","rgb(227,26,28)","rgb(253,191,111)","rgb(255,127,0)","rgb(202,178,214)","rgb(106,61,154)"],v={give:"Hosted",get:"Attended",mutual:"Shared"},f=function(t){t&&(t.length>p.length&&(p=t),u[t]||(u[t]=1))},y=function(t){var e=[];t.get&&e.push(t.get);for(var n=2;t["get_"+n];)e.push(t["get_"+n]),n++;return e},b=function(t){var e={};$.each(t.relationships,function(t,n){$.each(n,function(n,a){$.each(a,function(n,a){e[a.id]={id:a.id,type:t}})})}),P(t.name,e,l[0].type)},x=function(){var t=u[l[0].name];b(t)},A=function(){$.each(g,function(t,e){f(e.give),$.map(y(e),f)});var e=t.append("text").attr("id","maxLabel").text(p);i=$("#maxLabel")[0].getBBox().width,e.remove();var n=0;$.each(Object.keys(u).sort(),function(t,e){d=d.concat(n,n+1,n+2),u[e]={name:e,relationships:{give:{},get:{},mutual:{}},counts:{}},$.each(["give","get","mutual"],function(t,a){u[e][a]=n,u[e].counts[a]={count:0,participants:0,districts:{}},d[n]=[];for(var i=0;i<Object.keys(u).length;i++)d[n].push(0),d[n].push(0),d[n].push(0);l[n]={index:n,name:e,type:a},n++})});var a=function(t,e,n,a,i){if(t!==e){var o=function(t,e,i){var o={id:n,type:i,count:a},r=u[l[t].name],s=u[l[e].name];void 0===r.relationships[i][s.name]?(r.relationships[i][s.name]=[o],r.counts[i].districts[s.name]={count:0,participants:0}):r.relationships[i][s.name].push(o)};i?(d[e][t]+=1/a,o(t,e,"mutual")):(d[e][t]++,d[t][e]+="normalized"===c?1/a:1,o(t,e,"give"),o(e,t,"get"))}};$.each(g,function(t,e){var n=y(e);if(e.give&&"CA Ed. Partners"!==u[e.give]){var i=u[e.give].give;u[e.give].counts.give.count++,u[e.give].counts.give.participants+=n.length,$.each(n,function(o,r){var s=u[r].get;u[r].counts.get.count++,u[r].counts.get.participants+=n.length,a(i,s,t,n.length),u[e.give].counts.give.districts[r].count++,u[e.give].counts.give.districts[r].participants+=n.length})}else $.each(n,function(e,i){u[i].counts.mutual.count++,u[i].counts.mutual.participants+=n.length,$.each(n,function(e,o){var r=u[i].mutual,s=u[o].mutual;a(r,s,t,n.length,!0),r!==s&&(u[i].counts.mutual.districts[o].count++,u[i].counts.mutual.districts[o].participants+=n.length)})})}),z()},k=function(t){return a.groups()[t].startAngle},w=function(t){return a.groups()[t].endAngle},M=function(){c=$("input:radio[name=display-type]:checked").val(),d=[],p="",u={},l={},t.selectAll("*").remove(),A(),$("#info").hide()},C=function(){n.style("top",d3.event.pageY+5+"px"),n.style("left",d3.event.pageX+5+"px")},_=function(t){C(),n.style("display","block"),n.html(t)},O=function(){n.style("display","none")},P=function(t,e,n,a){$("#info .panel-title").html(t),$("#info .list-group").html(""),$.each(e,function(t,e){j(e.id,e.type)}),$("#info").css("display","flex"),$(".tab-content .list-group:empty").html('<li class="list-group-item"><div class="list-group-item-text">No experiences</div></li>'),$('#info .nav-tabs li a[href="#'+n+'s"]').tab("show"),$("#info .nav-tabs>li").toggle(!a)},j=function(t,e){var n=g[t],a=n.when+" - "+n.specificwhat;"Expert"===n.give&&(a+=" (Expert)"),"CAED"===u[n.give]&&(a+=" (Mutual)");var i="";i+=n._origGive?"<div>Host: "+n._origGive+"</div>":"",i+="Participants: "+y(n).join(", ");var o=n.survey&&n.survey.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.survey+'"> Survey</a>':"",r=n.onlinespace&&n.onlinespace.match(/^http/i)?' <a class="btn btn-default btn-sm" target="_blank" href="'+n.onlinespace+'"> Online Space</a>':"",s=o+r;$("#info #"+e+"s .list-group").append('<li class="row-info list-group-item"><span class="pull-right btn-group">'+s+'</span><h4 class="list-group-item-heading">'+a+'</h4><div class="list-group-item-text">'+i+"</div></li>")},R=function(t){return u[l[t.index].name]},z=function(){var e=function(e,n){return function(a,i){t.selectAll(".chords path").filter(function(t){return n?l[t.source.index].name!==l[a.index].name&&l[t.target.index].name!==l[a.index].name:a.source?t.source.index!==a.source.index||t.target.index!==a.target.index:t.source.index!==i&&t.target.index!==i}).transition().style("opacity",e)}},n=function(t){var e=l[t.index],n=m[Object.keys(u).indexOf(e.name)];return n};a=d3.layout.chord().padding(.02).sortChords(d3.descending).sortSubgroups(d3.descending).matrix(d),t.append("g").attr("class","district-groups").selectAll("path").data(a.groups().filter(function(t){return"give"===l[t.index].type})).enter().append("path").attr("class","district-group").style("fill",function(t){return n(t)}).style("stroke",function(t){return n(t)}),t.append("g").attr("class","chord-groups").selectAll("path").data(a.groups).enter().append("path").attr("class","chord-group").style("fill",function(t){return n(t)}).style("stroke",function(t){return n(t)}).on("mouseover",function(t,n){var a=R(t),i=l[t.index].type,o=v[i],r=a.counts[i].count,s=a.name+" "+o+" "+r+("mutual"===i?" Mutual":"")+" Experience"+(1===r?"":"s");_(s),e(.1)(t,n)}).on("mouseout",e(1)),t.append("g").attr("class","chords").selectAll("path").data(a.chords).enter().append("path").attr("class","chord").style("fill",function(t){var e=l[t.source.index];return"get"===e.type?n(t.target):"mutual"===e.type?"#999":n(t.source)}).style("opacity",1).on("click",function(t){var e="give"===l[t.source.index].type?"source":"target",n="give"===l[t.source.index].type?"target":"source",a=t[e].index,i=R(t[e]),o=R(t[n]),r=l[a].type,s="";s="mutual"===r?"Mutual between "+i.name+" and "+o.name:i.name+" to "+o.name,P(s,i.relationships[r][o.name],r,!0)}).on("mouseover",function(t,n){var a="give"===l[t.source.index].type?"source":"target",i="give"===l[t.source.index].type?"target":"source",o=t[a].index,r=R(t[a]),s=R(t[i]),c="",u=r.counts[l[o].type].districts[s.name];c="mutual"===l[o].type?r.name+" and "+s.name:r.name+" to  "+s.name,c+="<br>"+u.count+("mutual"===l[o].type?" Mutual":"")+" Experience"+(1===u.count?"":"s"),_(c),e(.1)(t,n)}).on("mouseout",e(1)),t.append("g").attr("class","sublabels").selectAll("text").data(a.groups).enter().append("text").attr("class","glyphicon sublabel").attr("pointer-events","none").each(function(t){t.angle=(k(t.index)+w(t.index))/2}).attr("dy",".4em").attr("fill",function(t){return d3.rgb(n(t)).darker(3)}),t.append("g").attr("class","labels").selectAll("text").data(a.groups().filter(function(t){return"give"===l[t.index].type})).enter().append("text").attr("class","district-label").each(function(t){t.center=(t.startAngle+w(t.index+2))/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.center>Math.PI?"end":null}).text(function(t){return l[t.index].name}),d3.selectAll(".district-label, .district-group").on("mouseover",function(t,n){var a=R(t),i=a.name+" - "+(a.counts.give.count+a.counts.get.count+a.counts.mutual.count)+" Experiences";_(i),e(.1,!0)(t,n)}).on("mouseout",e(1,!0)),d3.selectAll(".sublabel, .chord-group, .district-group, .district-label").on("click",function(t){var e=R(t);b(e)}),setTimeout(function(){x()},1e3),D()},D=function(){var e=$("#viz-container").width(),n=$("#content").height(),a=Math.min(e,n);$("#viz-container svg").attr("width",a).attr("height",a),t.attr("transform","translate("+a/2+","+a/2+")");var o=.5*a-i-10,r=.99*o,s=.98*r,c=.94*s,u=G(.7*(s-c));t.selectAll(".chord-group").attr("d",d3.svg.arc().innerRadius(c).outerRadius(s)),t.selectAll(".district-group").attr("d",function(t){return d3.svg.arc().startAngle(k(t.index)).endAngle(w(t.index+2)).innerRadius(r).outerRadius(o)()}),t.selectAll(".chord").attr("d",d3.svg.chord().radius(c)),t.selectAll(".sublabel").attr("font-size",u+"px").attr("transform",function(t){return"rotate("+(180*t.angle/Math.PI-90)+")translate("+(c+G(.15*(s-c)))+")"}).text(function(t){return(t.endAngle-t.startAngle)*c>u?"give"===l[t.index].type?"":"get"===l[t.index].type?"":"":void 0}),t.selectAll(".district-label").attr("transform",function(t){return"rotate("+(180*t.center/Math.PI-90)+")translate("+(o+5)+")"+(t.center>Math.PI?"rotate(180)":"")})},E=function(){var t=$(".worksheets").val(),e={};o=[];var n={},a={};$("#title").html(h[t].title+"<br><small>"+h[t].description+"</small>"),$.each(s[t].elements,function(t,i){a[i.account]=!0,n[i.surveyname]?"Attended"===i.hostattendmutual?e[i.surveyname][i.account]=!0:"Hosted"===i.hostattendmutual||"Mutual"===i.hostattendmutual?(n[i.surveyname].give=i.account,n[i.surveyname]._origGive=i.account):console.log("Bad data in 'Host Attend Mutual' column:",i.account,i.hostattendmutual):(n[i.surveyname]={},n[i.surveyname].essentialquestions=i.essentialquestions,e[i.surveyname]={},n[i.surveyname].specificwhat=i.surveyname,n[i.surveyname].when=i.date,n[i.surveyname].academicyear=i.academicyear,"Hosted"===i.hostattendmutual||"Mutual"===i.hostattendmutual?(n[i.surveyname].give=i.account,n[i.surveyname]._origGive=i.account):"Attended"===i.hostattendmutual?e[i.surveyname][i.account]=!0:console.log("Bad data in 'Host Attend Mutual' column:",i.account,i.hostattendmutual))}),$.each(e,function(t,e){var a="get",i=0;$.each(e,function(e){i>0&&(a="get_"+i),n[t][a]=e,i++})});var i=1;$.each(n,function(t,e){e.rowNumbers=i,o.push(e),i++});var c={};$.each(o,function(t,e){c[e.academicyear]=!0});var u=a;delete u.CAED,$("#participants").html(t+" Districts:<br>"+Object.keys(u).join(", ")),r=Object.keys(c),$(".academicyears").replaceWith('<div class="academicyears">'),$.each(Object.keys(c),function(t,e){$(".academicyears").append('<input class="yearbox" type="checkbox" checked="checked" value="'+e+'"><label>&nbsp'+e+"</label><br>")}),L(),H()},L=function(){$(".yearbox:checkbox").on("change",function(){r=[],r=$(":checkbox:checked").map(function(){return this.value}).get(),H()})},H=function(){g=[],$.each(o,function(t,e){if(-1!==r.indexOf(e.academicyear)){e.give=$.trim(e.give),e.get=$.trim(e.get);for(var n=1;e["get_"+n];)e["get_"+n]=$.trim(e["get_"+n]),n++;g.push(e)}}),$.each(g,function(t,e){e.give||console.log("Row "+t+" is missing its 'give' party: "+e),e.get||console.log("Row "+t+" is missing its 'get' party: "+e),e.when||console.log("Row "+t+" is missing a date: "+e),e.academicyear||console.log("Row "+t+" is missing its academic year: "+e),e.specificwhat||console.log("Row "+t+" is missing its description: "+e)}),M()},T=function(){$(".loading").hide(),$("#controls").css("display","flex"),t=d3.select("#viz-container").append("svg").attr("id","chordGraph").append("g").on("mousemove",function(){"none"!==n.style("display")&&C()}).on("mouseout",O),e=d3.select("#info"),$(".worksheets").on("change",E),$("#controls input").on("change",M),$(window).on("resize",D),n=d3.select("#content").append("div").attr("id","tooltip")},G=function(t){return+(Math.round(t+"e+2")+"e-2")};$(function(){var t,e=function(){t=Tabletop.init({key:"187AL-Ve6sOLP_-j58xk8ANHi1cZfheDzDSMInC4snOg",callback:function(t){if(!g[0]){s=t,$.each(t["Title Description"].elements,function(t,e){h[e.worksheetname]={title:e.title,description:e.description}}),s["Title Description"]&&delete s["Title Description"],s["Collaboration Participants"]&&delete s["Collaboration Participants"],s["Collaboration Particpants"]&&delete s["Collaboration Particpants"];var e=Object.keys(s);e=e.sort(function(t,e){return t=t.replace(/\s(\d)$/," 0$1"),e=e.replace(/\s(\d)$/," 0$1"),t.toLowerCase()<e.toLowerCase()?-1:t.toLowerCase()>e.toLowerCase()?1:0}),$.each(e,function(t,e){$(".worksheets").append("<option>"+e+"</option>")}),T(),E(),A()}},debug:!0})},n=function(){g[0]||(e(),setTimeout(n,5e3))};n()})}();